# # import json
# # import os
# #
# # DB_FILE = "projects.json"
# # SCAN_FILE = "last_scan.json"
# #
# # class ProjectDatabase:
# #     def __init__(self):
# #         self.projects = {}
# #         if os.path.exists(DB_FILE):
# #             with open(DB_FILE, "r", encoding="utf-8") as f:
# #                 self.projects = json.load(f)
# #
# #     def project_exists(self, project_id):
# #         return str(project_id) in self.projects
# #
# #     def add_project(self, project):
# #         self.projects[str(project["id"])] = project
# #         with open(DB_FILE, "w", encoding="utf-8") as f:
# #             json.dump(self.projects, f, ensure_ascii=False, indent=2)
# #
# #     def get_last_scan_time(self):
# #         if os.path.exists(SCAN_FILE):
# #             with open(SCAN_FILE, "r", encoding="utf-8") as f:
# #                 return json.load(f).get("last_scan")
# #         return None
# #
# #     def update_last_scan_time(self):
# #         from datetime import datetime
# #         with open(SCAN_FILE, "w", encoding="utf-8") as f:
# #             json.dump({"last_scan": datetime.utcnow().isoformat()}, f)
# #
# #     def close(self):
# #         pass
#
# import json
# import os
# from datetime import datetime
#
# DB_FILE = "projects.json"
# SCAN_FILE = "last_scan.json"
#
# class ProjectDatabase:
#     def __init__(self):
#         self.projects = {}
#         if os.path.exists(DB_FILE):
#             with open(DB_FILE, "r", encoding="utf-8") as f:
#                 self.projects = json.load(f)
#
#     def project_exists(self, project_id):
#         return str(project_id) in self.projects
#
#     def add_project(self, project):
#         self.projects[str(project["id"])] = project
#         with open(DB_FILE, "w", encoding="utf-8") as f:
#             json.dump(self.projects, f, ensure_ascii=False, indent=2)
#
#     def get_last_scan_time(self):
#         if os.path.exists(SCAN_FILE):
#             with open(SCAN_FILE, "r", encoding="utf-8") as f:
#                 date_str = json.load(f).get("last_scan")
#                 if date_str:
#                     try:
#                         return datetime.fromisoformat(date_str)
#                     except ValueError:
#                         print("‚ö†Ô∏è –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –¥–∞—Ç—É:", date_str)
#         return None
#
#     def update_last_scan_time(self):
#         with open(SCAN_FILE, "w", encoding="utf-8") as f:
#             json.dump({"last_scan": datetime.utcnow().isoformat()}, f)
#
#     def close(self):
#         pass

# db.py
# db.py
import sqlite3
from typing import Optional, List, Tuple
from datetime import datetime

DB_PATH = "projects.db"

# üèóÔ∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã
def initialize_db():
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # üë§ –ó–∞–∫–∞–∑—á–∏–∫–∏
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS employers (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            login TEXT UNIQUE,
            name TEXT,
            surname TEXT
        )
    ''')

    # üëÅÔ∏è –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS user_view_state (
    user_id INTEGER PRIMARY KEY,
    view_mode TEXT,
    current_index INTEGER,
    extra_filters TEXT,
    timestamp TEXT
    )
    ''')

    # üì¶ –ü—Ä–æ–µ–∫—Ç—ã
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS projects (
            id INTEGER PRIMARY KEY,
            title TEXT,
            link TEXT,
            short_description TEXT,
            full_description TEXT,
            budget_amount REAL,
            budget_currency TEXT,
            is_premium INTEGER,
            skills TEXT,
            published_at TEXT,
            employer_id INTEGER,
            is_processed INTEGER DEFAULT 0,
            FOREIGN KEY (employer_id) REFERENCES employers(id)
        )
    ''')

    # üéØ –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —Å—Ç–æ–ª–±—Ü—ã, –µ—Å–ª–∏ –æ–Ω–∏ –µ—â—ë –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
    # SQLite –Ω–µ –∏–º–µ–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ IF NOT EXISTS –¥–ª—è —Å—Ç–æ–ª–±—Ü–æ–≤, –ø–æ—ç—Ç–æ–º—É –æ–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤ try
    try:
        cursor.execute("ALTER TABLE projects ADD COLUMN keywords_found TEXT;")
    except sqlite3.OperationalError:
        pass

    try:
        cursor.execute("ALTER TABLE projects ADD COLUMN clients_matched TEXT;")
    except sqlite3.OperationalError:
        pass

    try:
        cursor.execute("ALTER TABLE projects ADD COLUMN is_favorite INTEGER DEFAULT 0;")
    except sqlite3.OperationalError:
        pass

    try:
        cursor.execute("ALTER TABLE projects ADD COLUMN reply_text TEXT;")
    except sqlite3.OperationalError:
        pass

    conn.commit()
    conn.close()
    print("‚úÖ –ë–∞–∑–∞ –∏ —Ç–∞–±–ª–∏—Ü—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã.")

# üë§ –ó–∞–∫–∞–∑—á–∏–∫: –ø–æ–ª—É—á–∏—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å
def get_or_create_employer(login: str, name: Optional[str], surname: Optional[str]) -> int:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute("SELECT id FROM employers WHERE login = ?", (login,))
    result = cursor.fetchone()
    if result:
        conn.close()
        return result[0]

    cursor.execute(
        "INSERT INTO employers (login, name, surname) VALUES (?, ?, ?)",
        (login, name or "", surname or "")
    )
    conn.commit()
    eid = cursor.lastrowid
    conn.close()
    return eid

# üì• –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
def insert_project(project: dict) -> bool:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute("SELECT id FROM projects WHERE id = ?", (project["id"],))
    if cursor.fetchone():
        conn.close()
        return False

    eid = get_or_create_employer(
        project.get("employer_login"),
        project.get("employer_name"),
        project.get("employer_surname")
    )

    skills_str = ", ".join(project.get("skills", [])) if isinstance(project.get("skills"), list) else ""

    cursor.execute('''
        INSERT INTO projects (
            id, title, link, short_description,
            budget_amount, budget_currency, is_premium, skills,
            published_at, employer_id
        )
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    ''', (
        project["id"],
        project.get("title"),
        project.get("link"),
        project.get("description"),
        project.get("budget_amount"),
        project.get("budget_currency"),
        int(bool(project.get("is_premium"))),
        skills_str,
        project.get("published_at"),
        eid
    ))

    conn.commit()
    conn.close()
    return True

# üîé –ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã
def get_unprocessed_projects() -> List[Tuple[int, str]]:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT id, link FROM projects WHERE is_processed = 0")
    rows = cursor.fetchall()
    conn.close()
    return rows

# –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–æ–≤ —Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π
def get_sorted_unprocessed_projects():
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        SELECT id, link FROM projects
        WHERE is_processed = 0
        ORDER BY published_at DESC
    """)
    rows = cursor.fetchall()
    conn.close()
    return rows

# üîê –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
def get_user_view_state(user_id: int) -> dict | None:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT view_mode, current_index, extra_filters, timestamp FROM user_view_state WHERE user_id = ?", (user_id,))
    row = cursor.fetchone()
    conn.close()
    if row:
        return {
            "view_mode": row[0],
            "current_index": row[1],
            "extra_filters": row[2],
            "timestamp": row[3]
        }
    return None

# üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
def save_user_view_state(user_id: int, view_mode: str, index: int, extra_filters: str = ""):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    now = datetime.now().isoformat()
    cursor.execute('''
        INSERT INTO user_view_state (user_id, view_mode, current_index, extra_filters, timestamp)
        VALUES (?, ?, ?, ?, ?)
        ON CONFLICT(user_id) DO UPDATE SET
            view_mode = excluded.view_mode,
            current_index = excluded.current_index,
            extra_filters = excluded.extra_filters,
            timestamp = excluded.timestamp
    ''', (user_id, view_mode, index, extra_filters, now))
    conn.commit()
    conn.close()

# –ß—Ç–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è –∏–∑ –ë–î
def fetch_full_description(project_id: int) -> str | None:
    print(f"[FUNC] üîç –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ {project_id}")
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        # –ü–æ–∫–∞–∂–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π SQL-–∑–∞–ø—Ä–æ—Å
        print(f"[FUNC] ‚ñ∂Ô∏è –í—ã–ø–æ–ª–Ω—è–µ–º SQL: SELECT full_description FROM projects WHERE id = {project_id}")
        cursor.execute("SELECT full_description FROM projects WHERE id = ?", (project_id,))
        row = cursor.fetchone()

        conn.close()

        if not row:
            print(f"[FUNC] ‚ö†Ô∏è –ù–µ—Ç —Å—Ç—Ä–æ–∫–∏ —Å —Ç–∞–∫–∏–º project_id ({project_id}) –≤ –ë–î.")
            return None

        description = row[0]

        # üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç—ã–µ –∏ —Å–ª—É–∂–µ–±–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        invalid_descriptions = ["", "‚ùå –û–ø–∏—Å–∞–Ω–∏–µ –ø—É—Å—Ç–æ–µ.", "‚è±Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –≤—Ä–µ–º–µ–Ω–∏."]
        if not description or description.strip() in invalid_descriptions:
            print(f"[FUNC] ‚ö†Ô∏è –û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–∞–≥–ª—É—à–∫—É: {repr(description)}")
            return None

        print(f"[FUNC] ‚úÖ –û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ: {repr(description[:100])}...")
        return description

    except Exception as e:
        print(f"[FUNC] ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –æ–ø–∏—Å–∞–Ω–∏—è –∏–∑ –ë–î: {e}")
        return None
# def fetch_full_description(project_id: int) -> str | None:
#     conn = sqlite3.connect(DB_PATH)
#     cursor = conn.cursor()
#     cursor.execute("SELECT full_description FROM projects WHERE id = ?", (project_id,))
#     row = cursor.fetchone()
#     conn.close()
#     return row[0] if row and row[0] else None

# üìù –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è
def update_project_description(project_id: int, full_description: str):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        UPDATE projects
        SET full_description = ?, is_processed = 2
        WHERE id = ?
    """, (full_description, project_id))
    conn.commit()
    conn.close()
    print(f"‚úèÔ∏è –ü—Ä–æ–µ–∫—Ç {project_id} –æ–±–Ω–æ–≤–ª—ë–Ω.")

def update_project_keywords(project_id: int, keywords: str):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute('''
        UPDATE projects
        SET keywords_found = ?
        WHERE id = ?
    ''', (keywords, project_id))
    conn.commit()
    conn.close()
    print(f"üîë –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ {project_id}.")

def update_project_clients(project_id: int, clients: str):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute('''
        UPDATE projects
        SET clients_matched = ?
        WHERE id = ?
    ''', (clients, project_id))
    conn.commit()
    conn.close()
    print(f"üßæ –ó–∞–∫–∞–∑—á–∏–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ {project_id}.")

def get_projects_by_status(status: str) -> List[Tuple[int, str]]:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        SELECT id, link FROM projects
        WHERE full_description = ?
        ORDER BY published_at DESC
    """, (status,))
    rows = cursor.fetchall()
    conn.close()
    return rows

def get_projects_excluding_status(excluded_status: str) -> List[Tuple[int, str]]:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        SELECT id, link FROM projects
        WHERE full_description != ?
        ORDER BY published_at DESC
    """, (excluded_status,))
    rows = cursor.fetchall()
    conn.close()
    return rows

def get_all_projects() -> List[Tuple[int, str]]:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        SELECT id, link FROM projects
        ORDER BY published_at DESC
    """)
    rows = cursor.fetchall()
    conn.close()
    return rows

def get_project_keywords(project_id: int) -> str:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        SELECT keywords_found FROM projects WHERE id = ?
    """, (project_id,))
    row = cursor.fetchone()
    conn.close()
    return row[0] if row and row[0] else ""

def get_project_clients(project_id: int) -> str:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        SELECT clients_matched FROM projects WHERE id = ?
    """, (project_id,))
    row = cursor.fetchone()
    conn.close()
    return row[0] if row and row[0] else ""

def keyword_matches_project(pid: int, keywords: list[str]) -> bool:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT keywords_found FROM projects WHERE id = ?", (pid,))
    row = cursor.fetchone()
    conn.close()

    if not row or not row[0]:
        return False

    keywords_text = row[0].lower()
    return any(keyword in keywords_text for keyword in keywords)

# –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã:
# | –°—Ç–∞—Ç—É—Å | is_processed | –ì–¥–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å |
# | –ù–æ–≤—ã–π | 0 | get_sorted_unprocessed_projects() |
# | –û—Ç–∫–ª–æ–Ω—ë–Ω–Ω—ã–π | 1 | get_projects_by_status(1) |
# | –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π | 2 | get_projects_by_status(2) |
def get_projects_by_is_processed(status: int) -> List[Tuple[int, str]]:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        SELECT id, link FROM projects
        WHERE is_processed = ?
        ORDER BY published_at DESC
    """, (status,))
    rows = cursor.fetchall()
    conn.close()
    return rows

def mark_project_as_declined(project_id: int):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        UPDATE projects
        SET is_processed = 1
        WHERE id = ?
    """, (project_id,))
    conn.commit()
    conn.close()
    print(f"üö´ –ü—Ä–æ–µ–∫—Ç {project_id} –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ –æ—Ç–∫–ª–æ–Ω—ë–Ω–Ω—ã–π.")

def mark_project_as_favorite(project_id: int):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        UPDATE projects
        SET is_favorite = 1
        WHERE id = ?
    """, (project_id,))
    conn.commit()
    conn.close()
    print(f"‚≠ê –ü—Ä–æ–µ–∫—Ç {project_id} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ.")

def remove_project_from_favorite(project_id: int):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        UPDATE projects
        SET is_favorite = 0
        WHERE id = ?
    """, (project_id,))
    conn.commit()
    conn.close()
    print(f"üóëÔ∏è –ü—Ä–æ–µ–∫—Ç {project_id} —É–¥–∞–ª—ë–Ω –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ.")

def get_favorite_projects() -> List[Tuple[int, str]]:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        SELECT id, link FROM projects
        WHERE is_favorite = 1
        ORDER BY published_at DESC
    """)
    rows = cursor.fetchall()
    conn.close()
    return rows

def is_project_favorite(project_id: int) -> bool:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT is_favorite FROM projects WHERE id = ?", (project_id,))
    result = cursor.fetchone()
    conn.close()
    return bool(result and result[0] == 1)

def save_reply_text(project_id: int, reply: str):
    print(f"[DB] üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º reply_text –≤ –ë–î –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ {project_id}")
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("UPDATE projects SET reply_text = ? WHERE id = ?", (reply, project_id))
    print(f"[DB] üéØ –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: {cursor.rowcount}")  # –î–æ–±–∞–≤–∏–º —ç—Ç–æ
    conn.commit()
    conn.close()
    print(f"[DB] ‚úÖ –û—Ç–∫–ª–∏–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ {project_id}")

def get_reply_text(project_id: int) -> str | None:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
    SELECT reply_text FROM projects WHERE id = ?
    """, (project_id,))
    row = cursor.fetchone()
    conn.close()
    return row[0] if row and row[0] else None

def proverka_db():
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT COUNT(*) FROM projects WHERE reply_text IS NOT NULL")
    reply_count = cursor.fetchone()[0]
    conn.close()
    return reply_count

